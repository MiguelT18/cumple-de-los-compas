---
import "../global.css";
import { Icon } from "astro-icon/components";
import client from "../lib/mongodb";

const USERS_PER_PAGE = 4;
const page = Number(Astro.url.searchParams.get("page") ?? 1);
const offset = (page - 1) * USERS_PER_PAGE;

let students = [];
let totalStudents = 0;

await client.connect();
const db = client.db("students_db");
const collection = db.collection("students");

totalStudents = await collection.countDocuments();
students = await collection
  .find()
  .sort({ _id: -1 })
  .skip(offset)
  .limit(USERS_PER_PAGE)
  .toArray();

const totalPages = Math.ceil(totalStudents / USERS_PER_PAGE);
const hasPrev = page > 1;
const hasNext = page < totalPages;
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Locos Informáticos</title>
  </head>
  <body class="bg-background">
    <main class="container max-w-[980px] mx-auto max-md:pb-5">
      <div
        class="w-full flex flex-col items-center justify-center gap-1 mb-4 pt-5 px-5"
      >
        <h1
          class="flex items-center gap-2 text-lg font-bold text-text-dark text-center"
        >
          <Icon name="charm:graduate-cap" class="size-10 text-primary" />
          Locos Informáticos
        </h1>
        <p class="text-text-medium text-sm text-center">
          Directorio de estudiantes de la carrera de Informática de la
          Universidad Autónoma Juan Misael Saracho
        </p>
      </div>

      <section class="flex items-stretch max-md:flex-col gap-4 px-4">
        <article class="bg-white p-4 rounded-xl w-full h-auto">
          <h2
            class="flex items-center gap-2 text-md font-medium font-sans text-text-dark mb-4"
          >
            <Icon name="mingcute:user-add-line" class="size-5 text-primary" />
            Únete al Grupo
          </h2>

          <form
            method="POST"
            class="h-full flex flex-col gap-2"
            id="student-form"
          >
            <div class="flex flex-col gap-1">
              <label for="full_name" class="text-text-medium">
                Nombre completo
              </label>
              <input
                type="text"
                name="full_name"
                id="full_name"
                placeholder="John Doe"
                class="p-2 rounded-md border-gray-400 border outline-primary hover:border-primary/80 transition-colors focus:border-2 focus:outline-primary cursor-pointer"
              />
              <span
                class="error-message text-red-500 text-xs hidden"
                data-field="full_name"></span>
            </div>

            <div class="flex flex-col gap-1">
              <label for="gender" class="text-text-medium"> Género </label>
              <select
                name="gender"
                id="gender"
                class="p-2 rounded-md border-gray-400 border outline-primary hover:border-primary/80 transition-colors focus:border-2 focus:outline-primary cursor-pointer"
              >
                <option value="">Selecciona un género</option>
                <option value="male">Masculino</option>
                <option value="female">Femenino</option>
                <option value="other">Prefiero no decirlo</option>
              </select>
              <span
                class="error-message text-red-500 text-xs hidden"
                data-field="gender"></span>
            </div>

            <div class="flex flex-col gap-1">
              <label for="born_at" class="text-text-medium">
                Fecha de nacimiento
              </label>
              <input
                type="date"
                name="born_at"
                id="born_at"
                class="p-2 rounded-md border-gray-400 border outline-primary hover:border-primary/80 transition-colors focus:border-2 focus:outline-primary cursor-pointer"
              />
              <span
                class="error-message text-red-500 text-xs hidden"
                data-field="born_at"></span>
            </div>

            <div class="flex flex-col gap-1">
              <label for="phone" class="text-text-medium"> Teléfono </label>
              <input
                type="tel"
                name="phone"
                id="phone"
                value="+591 "
                placeholder="+591 61234567"
                class="p-2 rounded-md border-gray-400 border outline-primary hover:border-primary/80 transition-colors focus:border-2 focus:outline-primary cursor-pointer"
              />
              <span
                class="error-message text-red-500 text-xs hidden"
                data-field="phone"></span>
            </div>

            <div class="flex flex-col gap-1">
              <label for="email" class="text-text-medium">
                Correo electrónico
              </label>
              <input
                type="email"
                name="email"
                id="email"
                placeholder="user@example.com"
                class="p-2 rounded-md border-gray-400 border outline-primary hover:border-primary/80 transition-colors focus:border-2 focus:outline-primary cursor-pointer"
              />
              <span
                class="error-message text-red-500 text-xs hidden"
                data-field="email"></span>
            </div>

            <div id="form-error" class="text-red-500 text-sm hidden"></div>
            <div id="form-success" class="text-green-600 text-sm hidden"></div>

            <button
              type="submit"
              class="py-3 bg-primary rounded-md text-white w-full mt-3 cursor-pointer outline-0 hover:bg-primary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              id="submit-btn"
            >
              Agregar mi información
            </button>
          </form>
        </article>

        <article
          class="bg-white p-4 rounded-xl w-full h-auto flex flex-col"
          id="students-article"
        >
          <div class="flex flex-col gap-1">
            <h2
              class="flex items-center gap-2 text-md font-medium font-sans text-text-dark"
            >
              <Icon name="lucide:users" class="text-primary size-5" />
              Estudiantes de Ing. Informática
            </h2>
            <span
              class="text-text-medium text-xs text-end w-full inline-block"
              id="students-count"
              data-count={totalStudents}>({totalStudents} estudiantes)</span
            >
          </div>

          {
            students.length === 0 ? (
              <div
                class="min-h-[200px] h-full grid place-content-center py-4"
                id="students-empty"
              >
                <p class="block text-center text-text-light text-xs text-balance">
                  Aún no hay estudiantes registrados. ¡Sé el primero en unirte!
                </p>
              </div>
            ) : (
              <div class="flex flex-col gap-4 py-4 h-full justify-between">
                <ul class="flex flex-col gap-3" id="students-list">
                  {students.map((student: any) => (
                    <li class="p-3 border rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-between gap-3 group">
                      <div class="flex items-center gap-3">
                        <div class="size-10 rounded-full bg-primary/10 text-primary flex items-center justify-center font-bold">
                          {student.full_name.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex flex-col">
                          <span class="font-medium text-text-dark">
                            {student.full_name}
                          </span>
                          <span class="text-xs text-text-medium">
                            {(() => {
                              const date = new Date(student.born_at);
                              const day = String(date.getDate()).padStart(
                                2,
                                "0",
                              );
                              const month = String(
                                date.getMonth() + 1,
                              ).padStart(2, "0"); // Enero = 0
                              const year = date.getFullYear();
                              return `${day}-${month}-${year}`;
                            })()}
                          </span>
                        </div>
                      </div>
                    </li>
                  ))}
                </ul>

                {totalPages > 1 && (
                  <div class="flex items-center justify-center gap-2 mt-auto pt-4 border-t">
                    <a
                      href={`/?page=${page - 1}`}
                      class={`p-2 rounded-md transition-colors ${
                        !hasPrev
                          ? "pointer-events-none opacity-50 text-gray-400"
                          : "hover:bg-gray-100 text-text-dark"
                      }`}
                      aria-disabled={!hasPrev}
                    >
                      <Icon name="lucide:chevron-left" class="size-5" />
                    </a>
                    <span
                      class="text-sm text-text-medium"
                      id="pagination-info"
                      data-current-page={page}
                      data-total-pages={totalPages}
                    >
                      Página {page} de {totalPages}
                    </span>
                    <a
                      href={`/?page=${page + 1}`}
                      id="pagination-next"
                      class={`p-2 rounded-md transition-colors ${
                        !hasNext
                          ? "pointer-events-none opacity-50 text-gray-400"
                          : "hover:bg-gray-100 text-text-dark"
                      }`}
                      aria-disabled={!hasNext}
                    >
                      <Icon name="lucide:chevron-right" class="size-5" />
                    </a>
                  </div>
                )}
              </div>
            )
          }
        </article>
      </section>
    </main>
  </body>
</html>

<script>
  import { studentSchema } from "../lib/schemas";
  import { actions } from "astro:actions";

  const form = document.getElementById("student-form") as HTMLFormElement;
  const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
  const formError = document.getElementById("form-error") as HTMLDivElement;
  const formSuccess = document.getElementById("form-success") as HTMLDivElement;
  const phoneInput = document.getElementById("phone") as HTMLInputElement;
  const studentsCount = document.getElementById(
    "students-count",
  ) as HTMLSpanElement | null;
  const studentsList = document.getElementById(
    "students-list",
  ) as HTMLUListElement | null;
  const studentsEmpty = document.getElementById(
    "students-empty",
  ) as HTMLDivElement | null;

  const MAX_USERS_PER_PAGE = 5;

  const updateStudentsUI = (student: any) => {
    if (!studentsCount) return;

    let currentTotal = Number(studentsCount.dataset.count ?? "0");
    if (Number.isNaN(currentTotal)) {
      currentTotal = 0;
    }

    const newTotal = currentTotal + 1;
    studentsCount.dataset.count = String(newTotal);
    studentsCount.textContent = `(${newTotal} estudiantes)`;

    let list = studentsList;

    if (!list) {
      const wrapper = document.createElement("div");
      wrapper.className = "flex flex-col gap-4 py-4 h-full justify-between";

      list = document.createElement("ul");
      list.id = "students-list";
      list.className = "flex flex-col gap-3";

      wrapper.appendChild(list);

      if (studentsEmpty && studentsEmpty.parentElement) {
        studentsEmpty.parentElement.replaceChild(wrapper, studentsEmpty);
      }
    }

    if (!list) return;

    const item = document.createElement("li");
    item.className =
      "p-3 border rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-between gap-3 group";

    const fullName =
      student && typeof student.full_name === "string"
        ? student.full_name.trim()
        : "";
    const initial =
      fullName.length > 0 ? fullName.charAt(0).toUpperCase() : "?";

    item.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-full bg-primary/10 text-primary flex items-center justify-center">
          ${initial}
        </div>
        <div class="flex flex-col">
          <span class="font-medium text-text-dark">${fullName}</span>
          <span class="text-xs text-text-medium">Ing. Informática</span>
        </div>
      </div>
    `;

    list.prepend(item);

    while (list.children.length > MAX_USERS_PER_PAGE) {
      const last = list.lastElementChild;
      if (!last) break;
      list.removeChild(last);
    }
  };

  phoneInput.addEventListener("input", (e) => {
    let value = phoneInput.value;

    // Si empieza con +591 pero no tiene espacio, agrega el espacio
    if (/^\+591(?!\s)/.test(value)) {
      const cursorPos = phoneInput.selectionStart ?? value.length;
      value = value.replace(/^\+591(?!\s)/, "+591 ");
      phoneInput.value = value;

      // Ajustar la posición del cursor para que no salte al final
      const newCursorPos = cursorPos + 1;
      phoneInput.setSelectionRange(newCursorPos, newCursorPos);
    }

    // prevenir que borre el +591
    if (!value.startsWith("+591")) {
      phoneInput.value = "+591 ";
    }
  });

  if (!form || !submitBtn || !formError || !formSuccess) {
    console.error("No se encontraron los elementos del formulario");
  } else {
    // Función para limpiar errores
    const clearErrors = () => {
      const errorMessages = form.querySelectorAll(".error-message");
      errorMessages.forEach((span) => {
        span.classList.add("hidden");
      });
      formError.classList.add("hidden");
      formSuccess.classList.add("hidden");
    };

    // Función para mostrar errores de validación
    const showValidationErrors = (
      errors: Record<string, string[] | undefined>,
    ) => {
      const errorMessages = form.querySelectorAll(".error-message");
      errorMessages.forEach((span) => {
        const field = span.getAttribute("data-field");
        if (field && errors[field]) {
          span.textContent = errors[field]?.[0] || "";
          span.classList.remove("hidden");
        }
      });

      // Resaltar campos con error
      Object.keys(errors).forEach((field) => {
        const input = form.querySelector(`[name="${field}"]`) as
          | HTMLInputElement
          | HTMLSelectElement;
        if (input) {
          input.classList.add("border-red-500");
        }
      });
    };

    // Manejar envío del formulario
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearErrors();

      const formData = new FormData(form);

      const data = {
        full_name: formData.get("full_name")?.toString() ?? "",
        gender: formData.get("gender")?.toString() ?? "",
        born_at: formData.get("born_at")?.toString() ?? "",
        phone: formData.get("phone")?.toString() ?? "",
        email: formData.get("email")?.toString() ?? "",
      };

      // Validar con Zod
      const validationResult = studentSchema.safeParse(data);

      if (!validationResult.success) {
        const errors = validationResult.error.flatten().fieldErrors;
        showValidationErrors(errors);
        return;
      }

      const validData = validationResult.data;

      // Si la validación pasa, enviar al servidor
      submitBtn.textContent = "Enviando...";
      submitBtn.disabled = true;

      try {
        const result = await actions.sendForm(validData);

        if (result.error) {
          formError.textContent =
            result.error.message || "Error al procesar el formulario";
          formError.classList.remove("hidden");
          submitBtn.disabled = false;
          submitBtn.textContent = "Agregar información";

          if ((result.error as any).issues) {
            showValidationErrors((result.error as any).issues);
          }
        } else if (result.data) {
          formSuccess.textContent = "Estudiante agregado correctamente";
          formSuccess.classList.remove("hidden");
          form.reset();
          submitBtn.disabled = false;
          submitBtn.textContent = "Agregar mi información";

          const createdStudent = (result.data as any).student;
          if (createdStudent) {
            updateStudentsUI(createdStudent);
          }

          setTimeout(() => {
            formSuccess.classList.add("hidden");
          }, 5000);
        }
      } catch (err) {
        formError.textContent =
          "Error de conexión. Por favor, intenta nuevamente.";
        formError.classList.remove("hidden");
        submitBtn.disabled = false;
        submitBtn.textContent = "Agregar mi información";
        // console.error("Error al enviar formulario:", err);
      } finally {
        submitBtn.textContent = "Agregar mi información";
        submitBtn.disabled = false;
      }
    });

    // Limpiar errores cuando el usuario empieza a escribir
    form.addEventListener("input", (e) => {
      const target = e.target as HTMLInputElement | HTMLSelectElement;
      if (target && target.name) {
        target.classList.remove("border-red-500");
        const errorSpan = form.querySelector(
          `[data-field="${target.name}"]`,
        ) as HTMLSpanElement;
        if (errorSpan) {
          errorSpan.classList.add("hidden");
        }
      }
    });
  }
</script>
